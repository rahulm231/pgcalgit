<?php
module_load_include('inc', 'site_ingestor', 'style_builder_styles');


function site_ingestor_theme($existing, $type, $theme, $path) {
  return array(
    'site_ingestor_style_builder' => array(
      'variables' => array(
        'themePath' => NULL,
        'modulePath' => NULL,
        'customizableStyles' => array(),
      ),
      'path' => $path . '/themes',
      'template' => 'site-ingestor-style-builder'
    ),
    'site_ingestor_region_selector' => array(
      'variables' => array(
        'themePath' => NULL,
        'themeName' => NULL,
        'templateFile' => NULL,
        'modulePath' => NULL,
        'regions' => array(),
      ),
      'path' => $path . '/themes',
      'template' => 'site-ingestor-region-selector'
    ),
  );
}

/*
 * Creates the basic files needed for a functional Drupal theme
 * using templates stored in the templates folder
 * Takes a finished SI object as an argument
 */
function site_ingestor_generate_theme($SI) {
  $templatesPath = \Drupal::root() . '/' . drupal_get_path('module', 'site_ingestor') . '/templates/';

  if(!isset($SI->dest)){
    return 'Site Ingestor object not prepared.';
  }

  // Info file
  if(!$infoFile = @file_get_contents($templatesPath.'theme.info'))
    return 'Unable to read theme info template file.';

  $infoFile = str_replace('{{themename}}', $SI->humanName, $infoFile);
  $infoFile = str_replace('{{themedescription}}', 'Generated by SiteIngestor.', $infoFile);

  if(!$result = @file_put_contents($SI->dest.'/'.$SI->systemName.'.info', $infoFile))
    return 'Unable to write theme info file.';

  // template.php
  if(($templatePHP = @file_get_contents($templatesPath.'template.php')) === FALSE)
    return 'Unable to read theme template.php template file.';

  // replace theme name
  $templatePHP = str_replace('{{themename}}', $SI->systemName, $templatePHP);

  if(!$result = @file_put_contents($SI->dest.'/template.php', $templatePHP))
    return 'Unable to write theme template.php file.';

  return TRUE;
}

/*
 * This function disables the admin toolbar if
 * "?hidetoolbar=true" is appended to any URL
 */
function site_ingestor_page_alter(&$page) {
  if(isset($_GET['hidetoolbar']) && $_GET['hidetoolbar'] == 'true')
    unset($page['page_top']['toolbar']);
}
